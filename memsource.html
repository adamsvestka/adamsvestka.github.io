<html>
    <body>
        <script>
            window.onmessage = async event => {
                if (!event.data.memsource) return;
                const results = await Promise.all(event.data.requests.map(async request => {
                    let result = {};
                    try {
                        const { method, headers, body } = request.payload || {};
                        const response = await fetch(request.url, { method, headers, body, mode: 'cors', credentials: 'omit' });
                        const temp = {};
                        for (const key of ['ok', 'status', 'statusText']) temp[key] = response[key];
                        result = {
                            ...temp,
                            headers: Object.fromEntries(response.headers),
                            text: response.status != 204 ? await response.text() : null
                        };
                    } catch (error) {
                        result = {
                            ...result,
                            ok: false,
                            error: error.message
                        };
                    }
                    return result;
                }));
                window.parent.postMessage(results, '*');
            }
        </script>
    </body>
</html>
